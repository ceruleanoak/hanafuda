<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hanafuda Koi-Koi</title>

  <!-- Cache Control: Prevent aggressive browser caching -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <link rel="icon" type="image/svg+xml" href="/hanafuda/favicon.svg">
  <link rel="stylesheet" href="./styles.css">
</head>
<body>
  <div id="app">
    <header>
      <h1>Hanafuda Koi-Koi</h1>
      <div id="game-info">
        <div id="score">
          <span>Player: <strong id="player-score">0</strong></span>
          <span>Opponent: <strong id="opponent-score">0</strong></span>
        </div>
        <button id="help-btn" title="Highlight matchable cards">Help</button>
        <button id="variations-btn" title="Toggle game variations">ðŸ’£</button>
        <button id="options-btn" title="Game options and rules">Options</button>
        <button id="test-3d-btn" title="Test 3D wave animation">ðŸŒŠ Wave</button>
        <button id="animation-tester-btn" title="Animation Testing Environment">ðŸŽ¬ Animator</button>
        <button id="new-game-btn">New Game</button>
      </div>
    </header>

    <main>
      <canvas id="game-canvas"></canvas>
      <div id="game-status"></div>

      <!-- Round Selection Modal -->
      <div id="round-modal" class="modal">
        <div class="modal-content">
          <h2>Select Number of Rounds</h2>
          <div class="modal-buttons">
            <button class="round-btn" data-rounds="1">1 Round</button>
            <button class="round-btn" data-rounds="3">3 Rounds</button>
            <button class="round-btn" data-rounds="6">6 Rounds</button>
            <button class="round-btn" data-rounds="12">12 Rounds</button>
          </div>
        </div>
      </div>

      <!-- Options Modal -->
      <div id="options-modal" class="modal">
        <div class="modal-content options-modal-content">
          <h2>Game Options</h2>

          <div class="options-grid">
            <div class="options-section">
              <h3>Koi-Koi Rules</h3>

              <div class="option-row">
                <label for="koikoi-enabled">
                  <input type="checkbox" id="koikoi-enabled" checked>
                  Enable Koi-Koi Decision
                </label>
                <span class="option-description">Choose to continue or end round after scoring</span>
              </div>

              <div class="option-row">
                <label for="multiplier-mode">Multiplier Mode:</label>
                <select id="multiplier-mode">
                  <option value="2x" selected>2x (Single Double)</option>
                  <option value="cumulative">2xâ†’3xâ†’4x (Cumulative)</option>
                </select>
                <span class="option-description">How points multiply after koi-koi</span>
              </div>

              <div class="option-row">
                <label for="auto-double">
                  <input type="checkbox" id="auto-double" checked>
                  Auto-double 7+ Points
                </label>
                <span class="option-description">Scores of 7+ automatically double</span>
              </div>
            </div>

            <div class="options-section">
              <h3>Yaku &amp; Scoring</h3>

              <div class="option-row">
                <label for="both-players-score">
                  <input type="checkbox" id="both-players-score">
                  Both Players Score
                </label>
                <span class="option-description">When OFF (default): winner-take-all scoring (traditional koi-koi)</span>
              </div>

              <div class="option-row">
                <label for="viewing-sake">Viewing Sake (Hanami):</label>
                <select id="viewing-sake">
                  <option value="always" selected>Always Enabled</option>
                  <option value="never">Always Disabled</option>
                  <option value="requireOther">Require Other Yaku</option>
                </select>
                <span class="option-description">Curtain + Sake Cup = 3 points</span>
              </div>

              <div class="option-row">
                <label for="moon-viewing-sake">Moon Viewing Sake (Tsukimi):</label>
                <select id="moon-viewing-sake">
                  <option value="always" selected>Always Enabled</option>
                  <option value="never">Always Disabled</option>
                  <option value="requireOther">Require Other Yaku</option>
                </select>
                <span class="option-description">Moon + Sake Cup = 3 points</span>
              </div>
            </div>

            <div class="options-section">
              <h3>Appearance</h3>

              <div class="option-row">
                <label for="animations-enabled">
                  <input type="checkbox" id="animations-enabled" checked>
                  Enable 3D Animations
                </label>
                <span class="option-description">Show animated card movements with 3D physics-based system</span>
              </div>
            </div>
          </div>

          <div class="modal-buttons">
            <button id="options-save">Save</button>
            <button id="options-reset">Reset to Defaults</button>
            <button id="options-cancel">Cancel</button>
          </div>
        </div>
      </div>

      <!-- Variations Modal -->
      <div id="variations-modal" class="modal">
        <div class="modal-content variations-modal-content">
          <h2>Game Variations</h2>
          <p class="variations-description">Toggle special game variations. These are advanced house rules that change gameplay mechanics.</p>

          <div class="variations-list">
            <div class="variation-item">
              <div class="variation-header">
                <span class="variation-emoji">ðŸ’£</span>
                <h3>Bomb Variation</h3>
                <span class="variation-badge variation-badge-working">âœ… Working</span>
              </div>
              <p class="variation-description">
                <strong>How it works:</strong> Play multiple matching cards simultaneously by selecting them in your hand. Receive "bomb cards" (pass cards) to maintain hand balance.
              </p>
              <p class="variation-how-to">
                <strong>Instructions:</strong><br>
                1. Select 2+ cards of the same month from your hand<br>
                2. Click a matching field card to play all selected cards<br>
                3. Receive (N-1) bomb cards back (e.g., play 2 cards â†’ get 1 bomb)<br>
                4. Bomb cards discard when played (free pass)
              </p>
              <p class="variation-status">
                <strong>Note:</strong> Players start with 10 cards each (instead of 8) when this variation is enabled. Game resets when toggled.
              </p>
              <label class="variation-toggle">
                <input type="checkbox" id="bomb-variation-enabled">
                <span class="toggle-label">Enable</span>
              </label>
            </div>
          </div>

          <div class="modal-buttons">
            <button id="variations-close" class="primary-btn">Close</button>
          </div>
        </div>
      </div>

      <!-- Koi-Koi Decision Modal -->
      <div id="koikoi-modal" class="modal">
        <div class="modal-content koikoi-modal-content">
          <h2>You Formed a Yaku!</h2>

          <div id="koikoi-yaku-display" class="koikoi-yaku-display">
            <!-- Will be filled with yaku names and points -->
          </div>

          <div class="koikoi-explanation">
            <p><strong>Choose your next move:</strong></p>
            <p><strong>Shobu:</strong> End the round now and keep your points (safe)</p>
            <p><strong>Koi-Koi:</strong> Continue playing to score more, but risk opponent doubling their points!</p>
          </div>

          <div class="modal-buttons">
            <button id="koikoi-shobu" class="koikoi-decision-btn">Shobu (End Round)</button>
            <button id="koikoi-continue" class="koikoi-decision-btn koikoi-risky">Koi-Koi! (Continue)</button>
          </div>
        </div>
      </div>

      <!-- Round Summary Modal -->
      <div id="round-summary-modal" class="modal">
        <div class="modal-content round-summary-content">
          <h2 id="round-summary-title">Round Complete!</h2>

          <div class="round-summary-scores">
            <div class="round-score-section">
              <h3>This Round</h3>
              <div class="score-breakdown">
                <div class="player-round-score">
                  <span class="player-label">You:</span>
                  <span id="player-round-points" class="round-points">0</span>
                  <span class="points-label">pts</span>
                </div>
                <div class="opponent-round-score">
                  <span class="player-label">Opponent:</span>
                  <span id="opponent-round-points" class="round-points">0</span>
                  <span class="points-label">pts</span>
                </div>
              </div>
            </div>

            <div class="round-score-section">
              <h3>Total Score</h3>
              <div class="score-breakdown">
                <div class="player-total-score">
                  <span class="player-label">You:</span>
                  <span id="player-total-points" class="total-points">0</span>
                  <span class="points-label">pts</span>
                </div>
                <div class="opponent-total-score">
                  <span class="player-label">Opponent:</span>
                  <span id="opponent-total-points" class="total-points">0</span>
                  <span class="points-label">pts</span>
                </div>
              </div>
            </div>
          </div>

          <div id="round-yaku-details" class="round-yaku-details">
            <!-- Will be filled with yaku details if any -->
          </div>

          <div class="modal-buttons">
            <button id="continue-next-round" class="primary-btn">Continue to Next Round</button>
          </div>
        </div>
      </div>

      <!-- Animation Tester Panel -->
      <div id="animation-tester-panel" class="animation-tester-panel hidden">
        <div class="animation-tester-controls">
          <div class="tester-header">
            <h3>Animation Tester</h3>
            <button id="close-animation-tester" class="close-btn">âœ•</button>
          </div>

          <div class="tester-actions">
            <button id="play-animation" class="primary-btn">â–¶ Play Animation</button>
            <button id="reset-animation" class="secondary-btn">â†º Reset</button>
            <button id="copy-params" class="secondary-btn">ðŸ“‹ Copy Parameters</button>
            <button id="copy-code" class="secondary-btn">ðŸ’¾ Copy Code</button>
          </div>

          <div class="tester-section">
            <h4>Preset Animations</h4>
            <select id="animation-preset">
              <option value="">-- Select Preset --</option>
              <option value="Simple Slide">Simple Slide</option>
              <option value="Flip While Moving">Flip While Moving</option>
              <option value="Arc Jump">Arc Jump</option>
              <option value="Spin and Grow">Spin and Grow</option>
              <option value="Fade Out">Fade Out</option>
              <option value="Bounce In (Back Easing)">Bounce In (Back Easing)</option>
              <option value="Victory Spin">Victory Spin</option>
              <option value="Flip and Fade">Flip and Fade</option>
            </select>
          </div>

          <div class="tester-section">
            <h4>Position</h4>
            <div class="control-group">
              <label>Start X: <span id="startX-value">200</span></label>
              <input type="range" id="startX" min="0" max="2000" value="200" step="10">
            </div>
            <div class="control-group">
              <label>Start Y: <span id="startY-value">300</span></label>
              <input type="range" id="startY" min="0" max="1200" value="300" step="10">
            </div>
            <div class="control-group">
              <label>Start Z: <span id="startZ-value">0</span></label>
              <input type="range" id="startZ" min="0" max="200" value="0" step="5">
            </div>
            <div class="control-group">
              <label>End X: <span id="endX-value">600</span></label>
              <input type="range" id="endX" min="0" max="2000" value="600" step="10">
            </div>
            <div class="control-group">
              <label>End Y: <span id="endY-value">300</span></label>
              <input type="range" id="endY" min="0" max="1200" value="300" step="10">
            </div>
            <div class="control-group">
              <label>End Z: <span id="endZ-value">0</span></label>
              <input type="range" id="endZ" min="0" max="200" value="0" step="5">
            </div>
          </div>

          <div class="tester-section">
            <h4>Animation</h4>
            <div class="control-group">
              <label>Duration (ms): <span id="duration-value">500</span></label>
              <input type="range" id="duration" min="100" max="3000" value="500" step="50">
            </div>
            <div class="control-group">
              <label>Easing:</label>
              <select id="easing">
                <option value="linear">Linear</option>
                <option value="easeInQuad">Ease In Quad</option>
                <option value="easeOutQuad">Ease Out Quad</option>
                <option value="easeInOutQuad" selected>Ease In Out Quad</option>
                <option value="easeOutCubic">Ease Out Cubic</option>
                <option value="easeInOutCubic">Ease In Out Cubic</option>
                <option value="easeOutBack">Ease Out Back (Bounce)</option>
              </select>
            </div>
          </div>

          <div class="tester-section">
            <h4>Rotation & Scale</h4>
            <div class="control-group">
              <label>Start Rotation (Â°): <span id="startRotation-value">0</span></label>
              <input type="range" id="startRotation" min="0" max="360" value="0" step="15">
            </div>
            <div class="control-group">
              <label>End Rotation (Â°): <span id="endRotation-value">0</span></label>
              <input type="range" id="endRotation" min="0" max="1440" value="0" step="15">
            </div>
            <div class="control-group">
              <label>Start Scale: <span id="startScale-value">1.0</span></label>
              <input type="range" id="startScale" min="0.1" max="3.0" value="1.0" step="0.1">
            </div>
            <div class="control-group">
              <label>End Scale: <span id="endScale-value">1.0</span></label>
              <input type="range" id="endScale" min="0.1" max="3.0" value="1.0" step="0.1">
            </div>
          </div>

          <div class="tester-section">
            <h4>Appearance</h4>
            <div class="control-group">
              <label>
                <input type="checkbox" id="startFaceUp" checked>
                Start Face Up
              </label>
            </div>
            <div class="control-group">
              <label>
                <input type="checkbox" id="endFaceUp" checked>
                End Face Up
              </label>
            </div>
            <div class="control-group">
              <label>Start Opacity: <span id="startOpacity-value">1.0</span></label>
              <input type="range" id="startOpacity" min="0" max="1" value="1" step="0.1">
            </div>
            <div class="control-group">
              <label>End Opacity: <span id="endOpacity-value">1.0</span></label>
              <input type="range" id="endOpacity" min="0" max="1" value="1" step="0.1">
            </div>
          </div>
        </div>
      </div>

      <!-- Tutorial Bubble -->
      <div id="tutorial-bubble" class="tutorial-bubble hidden">
        <div class="tutorial-content">
          <p><strong>New to Hanafuda?</strong></p>
          <p>Click the Help button to highlight matching cards!</p>
          <button id="tutorial-got-it">Got it!</button>
        </div>
        <div class="tutorial-arrow"></div>
      </div>
    </main>

    <footer>
      <div id="controls">
        <p id="instructions">Click cards to select them</p>
      </div>
    </footer>
  </div>

  <script type="module" src="./main.js"></script>
</body>
</html>
